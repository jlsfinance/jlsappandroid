

"use client";

import { useState, useEffect, useCallback } from "react";
import { useRouter, useParams } from "next/navigation";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useToast } from "@/hooks/use-toast";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Textarea } from "@/components/ui/textarea";
import { Separator } from "@/components/ui/separator";
import { Loader2, UserCheck, ArrowLeft, AlertTriangle } from "lucide-react";
import { db } from "@/lib/firebase";
import { doc, getDoc, updateDoc } from "firebase/firestore";
import Image from "next/image";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";

const loanEditSchema = z.object({
  amount: z.coerce.number().min(1000, "Minimum ₹1000"),
  interestRate: z.coerce.number().min(0).max(50, "Rate seems too high."),
  tenure: z.coerce.number().min(1, "Tenure must be at least 1 month."),
  processingFeePercentage: z.coerce.number().min(0).max(10, "Fee seems too high."),
  date: z.string().refine((val) => !isNaN(Date.parse(val)), { message: "Invalid date format." }),
  disbursalDate: z.string().optional().or(z.literal('')),
  notes: z.string().optional(),
});

type LoanEditFormValues = z.infer<typeof loanEditSchema>;

interface Customer {
  id: string;
  name: string;
  phone: string;
  address?: string;
  photo_url?: string;
}

interface LoanData {
    amount: number;
    interestRate: number;
    tenure: number;
    processingFeePercentage: number;
    date: string;
    disbursalDate?: string;
    notes?: string;
    customerId: string;
    status: 'Pending' | 'Approved' | 'Disbursed' | 'Completed' | 'Rejected';
}

export default function EditLoanPage() {
  const router = useRouter();
  const params = useParams();
  const loanId = params.loanId as string;
  const { toast } = useToast();

  const [customer, setCustomer] = useState<Customer | null>(null);
  const [loan, setLoan] = useState<LoanData | null>(null);
  const [loading, setLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const form = useForm<LoanEditFormValues>({
    resolver: zodResolver(loanEditSchema),
  });

  const fetchLoanAndCustomer = useCallback(async (id: string) => {
    setLoading(true);
    try {
        const loanRef = doc(db, "loans", id);
        const loanSnap = await getDoc(loanRef);

        if (!loanSnap.exists()) {
            toast({ variant: "destructive", title: "Loan Not Found", description: "This loan application does not exist." });
            router.push('/loans');
            return;
        }

        const loanData = loanSnap.data() as LoanData;
        setLoan(loanData);
        form.reset({
            amount: loanData.amount,
            interestRate: loanData.interestRate,
            tenure: loanData.tenure,
            processingFeePercentage: loanData.processingFeePercentage,
            date: loanData.date, // ISO string from DB (e.g., "2024-07-28")
            disbursalDate: loanData.disbursalDate || "",
            notes: loanData.notes || "",
        });

        const customerRef = doc(db, "customers", loanData.customerId);
        const customerSnap = await getDoc(customerRef);
        if (customerSnap.exists()) {
            setCustomer({ id: customerSnap.id, ...customerSnap.data() } as Customer);
        }

    } catch(err) {
      console.error(err)
      toast({ variant: "destructive", title: "Failed to load loan data." });
      router.push('/loans');
    } finally {
      setLoading(false);
    }
  }, [form, router, toast]);

  useEffect(() => {
    if (loanId) {
        fetchLoanAndCustomer(loanId);
    }
  }, [loanId, fetchLoanAndCustomer]);

  const onSubmit = async (data: LoanEditFormValues) => {
    if (!loanId || !customer) {
        toast({ variant: "destructive", title: "Error", description: "Loan or customer information is missing."});
        return;
    }

    setIsSubmitting(true);
    try {
      const processingFee = Math.round((data.amount * data.processingFeePercentage) / 100);
      const monthlyRate = data.interestRate / 12 / 100;
      const emi = Math.round(
        (data.amount * monthlyRate * Math.pow(1 + monthlyRate, data.tenure)) /
          (Math.pow(1 + monthlyRate, data.tenure) - 1)
      );

      const loanRef = doc(db, "loans", loanId);
      await updateDoc(loanRef, {
        amount: data.amount,
        interestRate: data.interestRate,
        tenure: data.tenure,
        processingFeePercentage: data.processingFeePercentage,
        processingFee,
        emi,
        date: data.date,
        disbursalDate: data.disbursalDate || null,
        notes: data.notes || null,
      });

      toast({
        title: "✅ Loan Application Updated",
        description: "The application details have been saved.",
      });

      router.push("/loans");
    } catch (e: any) {
      toast({
        variant: "destructive",
        title: "Update Error",
        description: e.message || "Could not update the loan.",
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  if (loading) {
      return (
          <div className="flex h-full w-full items-center justify-center">
              <Loader2 className="h-10 w-10 animate-spin text-primary" />
          </div>
      )
  }

  return (
    <div className="space-y-6">
       <div className="flex items-center gap-4">
            <Button variant="outline" size="icon" onClick={() => router.back()}><ArrowLeft className="h-4 w-4" /></Button>
            <h1 className="text-2xl font-headline font-semibold">Edit Loan Application</h1>
       </div>
      <Card className="max-w-4xl mx-auto shadow-lg">
        <CardHeader>
          <CardTitle>Update Loan Details</CardTitle>
           <CardDescription>
            You are editing loan ID: {loanId}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
              
              {customer && (
                <>
                 <Card className="bg-muted/50 p-4">
                  <div className="flex items-start gap-6">
                    <Image
                      src={customer.photo_url || "https://placehold.co/120x120.png"}
                      alt={customer.name}
                      width={120}
                      height={120}
                      className="rounded-md border-2 border-white shadow-md object-cover aspect-square"
                      data-ai-hint="person"
                    />
                    <div className="space-y-2 flex-1">
                      <h3 className="text-xl font-semibold flex items-center gap-2">
                        <UserCheck /> {customer.name}
                      </h3>
                      <p className="text-sm"><strong className="text-muted-foreground">Mobile:</strong> {customer.phone}</p>
                      <p className="text-sm"><strong className="text-muted-foreground">Address:</strong> {customer.address}</p>
                    </div>
                  </div>
                </Card>
                </>
              )}

            {loan && loan.status !== 'Pending' && (
                <Alert variant="destructive">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Warning: Editing an Active Loan</AlertTitle>
                    <AlertDescription>
                        This loan has already been {loan.status.toLowerCase()}. Any changes made here may impact the existing EMI schedule and financial records. Please proceed with caution. This action will not automatically regenerate the payment schedule.
                    </AlertDescription>
                </Alert>
            )}

            <Separator />
                
              <div className="space-y-4">
                <h3 className="text-lg font-medium text-primary">Loan Details</h3>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <FormField control={form.control} name="amount" render={({ field }) => (
                    <FormItem><FormLabel>Loan Amount (₹)</FormLabel><FormControl><Input {...field} type="number" /></FormControl><FormMessage /></FormItem>
                  )} />
                  <FormField control={form.control} name="tenure" render={({ field }) => (
                    <FormItem><FormLabel>Tenure (Months)</FormLabel><FormControl><Input {...field} type="number" /></FormControl><FormMessage /></FormItem>
                  )} />
                  <FormField control={form.control} name="interestRate" render={({ field }) => (
                    <FormItem><FormLabel>Interest Rate (% p.a.)</FormLabel><FormControl><Input {...field} type="number" step="0.1" /></FormControl><FormMessage /></FormItem>
                  )} />
                  <FormField control={form.control} name="processingFeePercentage" render={({ field }) => (
                    <FormItem><FormLabel>Processing Fee (%)</FormLabel><FormControl><Input {...field} type="number" step="0.1" /></FormControl><FormMessage /></FormItem>
                  )} />
                  <FormField control={form.control} name="date" render={({ field }) => (
                    <FormItem className="lg:col-span-1"><FormLabel>Application Date</FormLabel><FormControl><Input {...field} type="date" /></FormControl><FormMessage /></FormItem>
                  )} />
                  <FormField control={form.control} name="disbursalDate" render={({ field }) => (
                    <FormItem className="lg:col-span-1"><FormLabel>Disbursal Date</FormLabel><FormControl><Input {...field} type="date" /></FormControl><FormMessage /></FormItem>
                  )} />
                </div>
                <FormField control={form.control} name="notes" render={({ field }) => (
                  <FormItem><FormLabel>Internal Notes / Remarks</FormLabel><FormControl><Textarea {...field} placeholder="Add any internal notes about this application..." /></FormControl><FormMessage /></FormItem>
                )} />
              </div>
              <div className="flex justify-end">
                <Button type="submit" className="w-full sm:w-auto bg-accent hover:bg-accent/90 text-accent-foreground" disabled={isSubmitting || loading}>
                  {isSubmitting ? (
                    <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Updating...</>
                  ) : (
                    'Update Loan'
                  )}
                </Button>
              </div>
            </form>
          </Form>
        </CardContent>
      </Card>
    </div>
  );
}
